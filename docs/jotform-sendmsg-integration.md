# JotForm to SendMsg Integration Guide

## תוכן עניינים
1. [סקירה כללית](#סקירה-כללית)
2. [הגדרת JotForm](#הגדרת-jotform)
3. [הגדרת Webhook](#הגדרת-webhook)
4. [התאמה ללקוחות שונים](#התאמה-ללקוחות-שונים)
5. [פתרון בעיות](#פתרון-בעיות)
6. [בדיקה](#בדיקה)
7. [שאלות נפוצות](#שאלות-נפוצות)

## סקירה כללית

מערכת האינטגרציה בין JotForm ל-SendMsg מאפשרת העברה אוטומטית של נתוני טפסים שמתקבלים ב-JotForm אל מערכת הדיוור של SendMsg. המערכת מקבלת את הנתונים מ-JotForm דרך webhook, מחלצת את השדות הרלוונטיים (שם, אימייל, טלפון, תאריך לידה), ושולחת אותם לממשק API של SendMsg בפורמט המתאים.

המערכת כוללת שני endpoints עיקריים:
1. `/api/jotform-to-sendmsg` - Endpoint כללי לכל הלקוחות
2. `/api/sharoni` - Endpoint ייעודי ללקוחה "שרוני"

## הגדרת JotForm

### שדות נדרשים
כדי שהאינטגרציה תעבוד בצורה תקינה, הטופס ב-JotForm צריך לכלול את השדות הבאים:

1. **שם** - שדה טקסט עם תווית כגון "שם מלא", "שם", "fullname" וכו'
2. **אימייל** - שדה אימייל עם תווית כגון "מייל", "אימייל", "email" וכו'
3. **טלפון** - שדה טלפון עם תווית כגון "טלפון", "נייד", "סלולרי", "phone" וכו'
4. **תאריך לידה** (אופציונלי) - שדה תאריך עם תווית כגון "תאריך לידה", "birthday" וכו'

### שדה נסתר למזהה טופס (מומלץ)
כדי להתאים את הטופס ללקוח ספציפי ב-SendMsg, מומלץ להוסיף שדה נסתר (Hidden Field) לטופס ב-JotForm:

1. בעורך הטפסים של JotForm, לחץ על "Add Form Element"
2. בחר ב-"Hidden Field" תחת הקטגוריה "Quick Tools"
3. הגדר את שם השדה ל-"sendmsg_form_id" או "מזהה טופס"
4. הגדר את ערך ברירת המחדל של השדה למזהה הטופס הייחודי של SendMsg (למשל `338449__65661e0b-29e9-45ab-ad81-3470de641084`)

אם לא מוגדר שדה נסתר כזה, המערכת תשתמש במזהה טופס ברירת מחדל.

## הגדרת Webhook

כדי לחבר את הטופס ב-JotForm ל-endpoint שלנו:

1. היכנס לטופס ב-JotForm ולחץ על "Settings" בחלק העליון
2. בחר ב-"Integrations" בתפריט הצד
3. חפש "WebHooks" ולחץ עליו
4. בשדה "WebHook URL", הזן את כתובת ה-endpoint המתאים:
   - לקוחה שרוני: `https://[your-domain]/api/sharoni`
   - לקוחות אחרים: `https://[your-domain]/api/jotform-to-sendmsg`
5. לחץ על "Complete Integration"

### סוגי פורמט נתמכים

ה-endpoint תומך במספר פורמטים לקבלת נתונים:
1. **JSON** - כאשר הנתונים נשלחים בפורמט JSON עם Content-Type של `application/json`
2. **Form URL Encoded** - כאשר הנתונים נשלחים בפורמט URL-encoded עם Content-Type של `application/x-www-form-urlencoded`
3. **Multipart Form Data** - כאשר הנתונים נשלחים בפורמט multipart/form-data (נפוץ בטפסים שכוללים העלאת קבצים)
4. **פורמטים לא סטנדרטיים** - המערכת מנסה לזהות ולנתח גם נתונים שנשלחים בפורמטים אחרים או עם Content-Type לא מתאים

### מבנה הנתונים מ-JotForm

JotForm שולח את נתוני הטופס בפורמט JSON שכולל מגוון שדות, כאשר החשובים ביותר הם:

1. **formID** - מזהה הטופס ב-JotForm
2. **submissionID** - מזהה ייחודי של השליחה הספציפית
3. **pretty** - מחרוזת מפורמטת היטב שמכילה את כל נתוני הטופס בפורמט: `שם השדה:ערך, שם שדה אחר:ערך אחר`
4. **rawRequest** - מחרוזת JSON שמכילה את כל נתוני הטופס המפורטים

דוגמה למבנה נתונים שמגיע מ-JotForm:
```json
{
  "formID": "250364461330448",
  "submissionID": "6171250462311175586",
  "formTitle": "שרוני",
  "pretty": "שם מלא:אביץ, אימייל:avizma2eir@gmail.com, מספר טלפון:(123) 123-1232, מגדר:זכר",
  "rawRequest": "{\"q27_input27\":\"\\u05d0\\u05d1\\u05d9\\u05e5\",\"q5_input5\":\"avizma2eir@gmail.com\"...}"
}
```

המערכת חכמה מספיק כדי לחלץ את הנתונים הרלוונטיים מכל אחד מהשדות האלה, ומעדיפה את הפורמט המובנה יותר של השדות `pretty` או `rawRequest`.

## התאמה ללקוחות שונים

ישנן שתי אפשרויות להתאים את האינטגרציה ללקוחות שונים:

### אפשרות 1: שדה נסתר בג'וטפורם (מומלץ)
כפי שהוסבר למעלה, הוסף שדה נסתר עם מזהה הטופס של SendMsg. זו השיטה המומלצת כי:
- משתמשים באותו endpoint לכל הלקוחות
- קל לשנות את מזהה הטופס בלי לשנות קוד
- אין צורך ליצור endpoints נוספים לכל לקוח

### אפשרות 2: Endpoint ייעודי
ליצירת endpoint חדש ללקוח ספציפי:
1. העתק את הקובץ `src/app/api/sharoni/route.ts` לתיקייה חדשה בשם הלקוח
2. ערוך את הקובץ החדש ושנה את:
   - תגי היומן (מ-`[Sharoni API]` ל-`[Client Name API]`)
   - מזהה טופס SendMsg בשורה `sendMsgPayload.append('form', '...')`

## פתרון בעיות

### בדיקת היומנים
בעת התרחשות בעיה, ניתן לבדוק את היומנים ב-Vercel:
1. היכנס ללוח הבקרה של Vercel
2. בחר את הפרויקט
3. לחץ על "Deployments" ובחר את ה-deployment האחרון
4. לחץ על "Functions" ואז על הפונקציה הרלוונטית
5. בדוק את היומנים כדי לזהות בעיות אפשריות

### ניתוח השגיאות המורחב
המערכת כוללת יכולות דיבוג משופרות:
1. **רישום הגוף הגולמי של הבקשה** - הנתונים המקוריים שמתקבלים מ-JotForm נרשמים ביומן
2. **ניסיונות התאוששות** - המערכת מנסה פורמטים שונים לניתוח הנתונים אם הניתוח הראשוני נכשל
3. **רישום תוצאות החילוץ** - המערכת מדווחת על השדות שהצליחה לחלץ
4. **רישום פרטי התגובה** - התגובה מהשרת של SendMsg נרשמת ביומן

### בעיות נפוצות

1. **לא מתקבלים נתונים מ-JotForm**
   - ודא שה-webhook מוגדר נכון ב-JotForm
   - בדוק את היומנים לשגיאות ניתוח
   - וודא שאתה משתמש בכתובת ה-URL הנכונה להגדרת ה-webhook
   
2. **שגיאות ניתוח JSON**
   - אם מופיעה שגיאת JSON בלוגים, בדוק את הפורמט של הנתונים שנשלחים מ-JotForm
   - המערכת תנסה להתאושש משגיאות ניתוח JSON על ידי ניסיון לנתח את הנתונים כ-URL-encoded form
   
3. **בעיות עם Multipart Form Data**
   - JotForm לפעמים שולח את הנתונים בפורמט multipart/form-data, במיוחד בבקשות שמכילות קבצים
   - המערכת מזהה פורמט זה אוטומטית גם אם ה-Content-Type לא מוגדר נכון
   - אם אתה רואה בלוגים תוכן שמתחיל עם `Content-Disposition: form-data;`, זה סימן שמדובר בפורמט זה

4. **נתונים חסרים או לא נכונים נשלחים ל-SendMsg**
   - ודא שהשדות בטופס JotForm מכילים את המחרוזות בשמות השדות שהמערכת מחפשת
   - בדוק האם השדות משתמשים בשמות שונים מאלו שהמערכת מחפשת
   - בדוק את שדה ה-`pretty` בלוגים כדי לראות כיצד JotForm מכנה את השדות

5. **בעיות בפורמט תאריך**
   - המערכת מנסה להמיר תאריכים לפורמט הנדרש (DD-MM-YYYY)
   - אם התאריך בפורמט שלא ניתן לניתוח, התאם את הפורמט בטופס JotForm

## בדיקה

ניתן לבדוק את האינטגרציה באמצעות סקריפטי הבדיקה המצורפים:

### בדיקת האינטגרציה הכללית
```bash
# בדיקה בסביבת פיתוח מקומית
./test-jotform-to-sendmsg.sh

# בדיקה בסביבת הייצור
./test-jotform-to-sendmsg.sh prod
```

### בדיקת האינטגרציה המיועדת לשרוני
```bash
# בדיקה בסביבת פיתוח מקומית
./test-sharoni-endpoint.sh

# בדיקה בסביבת הייצור
./test-sharoni-endpoint.sh prod
```

לפני בדיקת הסביבה המופעלת, יש לעדכן את כתובת ה-URL בסקריפטי הבדיקה:
```bash
PROD_URL="https://[your-actual-domain].vercel.app/api/jotform-to-sendmsg"
```

## שאלות נפוצות

### האם אפשר להוסיף שדות נוספים ל-SendMsg?
כרגע, האינטגרציה תומכת בשדות הבאים:
- שם (פרמטר 4)
- אימייל (פרמטר email)
- טלפון סלולרי (פרמטר cellphone)
- תאריך לידה (פרמטר 6)
- מזהה טופס (פרמטר form)

אם צריך להוסיף שדות נוספים, יש לעדכן את הקוד ב-route.ts.

### האם האינטגרציה עובדת עם טפסים מסוגים אחרים מלבד JotForm?
כרגע, האינטגרציה מותאמת ספציפית לפורמט של JotForm. אם יש צורך בתמיכה בסוגי טפסים אחרים, יש ליצור endpoints נפרדים או להתאים את הלוגיקה לפורמטים נוספים.

### האם המערכת עמידה לשגיאות ניתוח?
כן, המערכת כוללת מנגנונים מתקדמים להתמודדות עם שגיאות ניתוח:
- היא תנסה לפרש את הנתונים בפורמטים שונים
- היא מדווחת באופן מפורט ביומנים על תהליך הניתוח
- גם אם חלק מהשדות לא זוהו, היא תמשיך ותשלח את הנתונים שכן זוהו לשרת SendMsg

### האם האינטגרציה תומכת בהעלאת קבצים?
המערכת מסוגלת לנתח בקשות multipart/form-data שבהן JotForm שולח את הנתונים, אך האינטגרציה לא מעבירה קבצים ל-SendMsg. היא מחלצת רק את שדות המידע הדרושים (שם, מייל, טלפון, תאריך לידה) ושולחת אותם. 